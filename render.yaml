# Blueprint para desplegar UBApp en Render
# Documentación: https://render.com/docs/blueprint-spec

services:
  # ============================================
  # BACKEND - Django REST API (Docker)
  # ============================================
  - type: web
    runtime: docker
    name: ubapp-backend
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    dockerCommand: ./start-render.sh
    healthCheckPath: /api/health/
    plan: free
    envVars:
      # Usa tu base de datos existente (Render solo permite 1 DB gratis).
      # Copia la "Internal Database URL" de tu PostgreSQL en Render Dashboard.
      - key: DATABASE_URL
        sync: false
      - key: REDIS_HOST
        fromService:
          type: keyvalue
          name: ubapp-redis
          property: host
      - key: REDIS_PORT
        fromService:
          type: keyvalue
          name: ubapp-redis
          property: port
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: "false"
      - key: ALLOWED_HOSTS
        value: ".onrender.com,localhost,127.0.0.1"
      - key: CORS_ALLOWED_ORIGINS
        value: "https://ubapp-frontend.onrender.com,http://localhost:4200"
      - key: CSRF_TRUSTED_ORIGINS
        value: "https://ubapp-frontend.onrender.com,http://localhost:4200"
      - key: OPENAI_API_KEY
        sync: false
      - key: OPENAI_EMBEDDING_MODEL
        value: "text-embedding-3-small"
      - key: OPENAI_EMBEDDING_DIMENSIONS
        value: "1536"

  # ============================================
  # FRONTEND - Angular SPA (Docker)
  # ============================================
  - type: web
    runtime: docker
    name: ubapp-frontend
    dockerfilePath: ./frontend/Dockerfile.render
    dockerContext: ./frontend
    plan: free
    envVars:
      # IMPORTANTE: Después del primer deploy del backend, copia su URL y agrégalo aquí.
      # Ej: https://ubapp-backend-xxxx.onrender.com/api
      - key: API_URL
        sync: false

  # ============================================
  # REDIS - Caché y sesiones
  # ============================================
  - type: keyvalue
    name: ubapp-redis
    ipAllowList:
      - source: 0.0.0.0/0
        description: everywhere
    plan: free
    maxmemoryPolicy: allkeys-lru

