<div class="importacion-excel-container">
  <!-- Encabezado -->
  <div class="header">
    <h2>üìä M√≥dulo de Carga y Procesamiento de Archivos Excel</h2>
    <p class="subtitle">Importe datos masivos de env√≠os desde archivos Excel con validaci√≥n y limpieza autom√°tica</p>
  </div>

  <!-- Mensajes de alerta -->
  <div *ngIf="mensajeError" class="alerta alerta-error">
    <span class="icono">‚ö†Ô∏è</span>
    <span>{{ mensajeError }}</span>
    <button class="btn-cerrar" (click)="mensajeError = ''">&times;</button>
  </div>

  <div *ngIf="mensajeExito" class="alerta alerta-exito">
    <span class="icono">‚úÖ</span>
    <span>{{ mensajeExito }}</span>
    <button class="btn-cerrar" (click)="mensajeExito = ''">&times;</button>
  </div>

  <!-- Indicador de progreso -->
  <div class="progress-steps">
    <div class="step" [class.active]="paso >= 1" [class.completed]="paso > 1">
      <div class="step-number">1</div>
      <div class="step-label">Cargar Archivo</div>
    </div>
    <div class="step-line" [class.completed]="paso > 1"></div>
    <div class="step" [class.active]="paso >= 2" [class.completed]="paso > 2">
      <div class="step-number">2</div>
      <div class="step-label">Mapear Columnas</div>
    </div>
    <div class="step-line" [class.completed]="paso > 2"></div>
    <div class="step" [class.active]="paso >= 3" [class.completed]="paso > 3">
      <div class="step-number">3</div>
      <div class="step-label">Validar y Seleccionar</div>
    </div>
    <div class="step-line" [class.completed]="paso > 3"></div>
    <div class="step" [class.active]="paso >= 4">
      <div class="step-number">4</div>
      <div class="step-label">Procesar</div>
    </div>
  </div>

  <!-- PASO 1: Cargar Archivo -->
  <div *ngIf="paso === 1" class="paso-container">
    <div class="card">
      <h3>üìÅ Paso 1: Cargar Archivo Excel</h3>
      
      <div class="upload-area">
        <input 
          type="file" 
          id="fileInput" 
          accept=".xlsx,.xls" 
          (change)="onArchivoSeleccionado($event)"
          #fileInput
        />
        <label for="fileInput" class="upload-label">
          <div class="upload-icon">üì§</div>
          <div class="upload-text">
            <strong>Haga clic para seleccionar</strong> o arrastre un archivo Excel
          </div>
          <div class="upload-hint">Formatos permitidos: .xlsx, .xls</div>
        </label>
      </div>

      <div *ngIf="archivoSeleccionado" class="archivo-info">
        <div class="archivo-nombre">
          <span class="icono">üìÑ</span>
          <span>{{ archivoSeleccionado.name }}</span>
        </div>
        <div class="archivo-tamano">
          {{ (archivoSeleccionado.size / 1024 / 1024).toFixed(2) }} MB
        </div>
      </div>

      <div *ngIf="previewDatos" class="preview-info">
        <h4>Vista Previa de Datos</h4>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total de Filas</div>
            <div class="stat-value">{{ previewDatos.total_filas }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Columnas</div>
            <div class="stat-value">{{ previewDatos.columnas.length }}</div>
          </div>
        </div>

        <!-- Tabla de vista previa -->
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>#</th>
                <th *ngFor="let columna of previewDatos.columnas">{{ columna }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let fila of filasPaginadas; let i = index">
                <td>{{ fila._indice + 1 }}</td>
                <td *ngFor="let columna of previewDatos.columnas">
                  {{ fila[columna] || '-' }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Paginaci√≥n -->
        <div *ngIf="totalPaginas > 1" class="paginacion">
          <button 
            (click)="paginaActual = paginaActual - 1" 
            [disabled]="paginaActual === 1"
            class="btn-paginacion">
            ‚Üê Anterior
          </button>
          <span class="pagina-info">P√°gina {{ paginaActual }} de {{ totalPaginas }}</span>
          <button 
            (click)="paginaActual = paginaActual + 1" 
            [disabled]="paginaActual === totalPaginas"
            class="btn-paginacion">
            Siguiente ‚Üí
          </button>
        </div>
      </div>

      <div class="acciones">
        <button class="btn btn-secondary" (click)="descargarPlantilla()">
          üì• Descargar Plantilla de Ejemplo
        </button>
        <button 
          class="btn btn-primary" 
          (click)="subirArchivo()"
          [disabled]="!archivoSeleccionado || cargando">
          <span *ngIf="!cargando">Continuar ‚Üí</span>
          <span *ngIf="cargando">‚è≥ Procesando...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- PASO 2: Mapear Columnas -->
  <div *ngIf="paso === 2" class="paso-container">
    <div class="card">
      <h3>üó∫Ô∏è Paso 2: Mapear Columnas del Excel</h3>
      <p>Asocie las columnas de su archivo Excel con los campos del sistema</p>
      <p class="info-text">
        <i class="fas fa-info-circle"></i>
        <strong>Nota:</strong> Las columnas que no se mapeen simplemente se ignorar√°n. 
        Solo es obligatorio mapear el campo <strong>HAWB</strong>.
      </p>

      <div class="mapeo-container">
        <div class="mapeo-grid">
          <div *ngFor="let columna of previewDatos?.columnas" class="mapeo-item">
            <label>{{ columna }}</label>
            <select [(ngModel)]="mapeoColumnas[columna]" class="select-mapeo">
              <option [ngValue]="null">-- No mapear --</option>
              <option 
                *ngFor="let campo of camposDisponibles" 
                [value]="campo.valor"
                [title]="campo.descripcion">
                {{ campo.etiqueta }} {{ campo.requerido ? '(*)' : '' }}
              </option>
            </select>
            <span class="campo-hint" *ngIf="mapeoColumnas[columna]">
              {{ obtenerDescripcionCampo(columna) }}
            </span>
          </div>
        </div>

        <div *ngIf="!mapeoValido" class="alerta alerta-warning">
          ‚ö†Ô∏è El campo <strong>HAWB</strong> es obligatorio. Por favor mapearlo antes de continuar.
        </div>
      </div>

      <div class="acciones">
        <button class="btn btn-secondary" (click)="paso = 1">
          ‚Üê Atr√°s
        </button>
        <button 
          class="btn btn-primary" 
          (click)="validarDatos()"
          [disabled]="!mapeoValido || cargando">
          <span *ngIf="!cargando">Validar Datos ‚Üí</span>
          <span *ngIf="cargando">‚è≥ Validando...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- PASO 3: Validar y Seleccionar -->
  <div *ngIf="paso === 3" class="paso-container">
    <div class="card">
      <h3>‚úÖ Paso 3: Validar y Seleccionar Registros</h3>

      <!-- Estad√≠sticas de validaci√≥n -->
      <div *ngIf="importacionActual" class="stats-grid">
        <div class="stat-card stat-success">
          <div class="stat-label">Registros V√°lidos</div>
          <div class="stat-value">{{ importacionActual.registros_validos }}</div>
        </div>
        <div class="stat-card stat-error">
          <div class="stat-label">Registros con Errores</div>
          <div class="stat-value">{{ importacionActual.registros_errores }}</div>
        </div>
        <div class="stat-card stat-warning">
          <div class="stat-label">Duplicados</div>
          <div class="stat-value">{{ importacionActual.registros_duplicados }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Registros</div>
          <div class="stat-value">{{ importacionActual.total_registros }}</div>
        </div>
      </div>

      <!-- Errores de validaci√≥n -->
      <div *ngIf="erroresValidacion.length > 0" class="errores-container">
        <h4>‚ö†Ô∏è Errores Detectados</h4>
        <div class="errores-lista">
          <div *ngFor="let error of erroresValidacion.slice(0, 10)" class="error-item">
            <span class="error-fila">Fila {{ error.fila }}</span>
            <span class="error-columna">{{ error.columna }}</span>
            <span class="error-mensaje">{{ error.error }}</span>
          </div>
          <div *ngIf="erroresValidacion.length > 10" class="error-item more">
            ... y {{ erroresValidacion.length - 10 }} errores m√°s
          </div>
        </div>
        <button class="btn btn-secondary" (click)="descargarReporteErrores()">
          üì• Descargar Reporte Completo de Errores
        </button>
      </div>

      <!-- Selecci√≥n de registros -->
      <div class="seleccion-container">
        <h4>Seleccionar Registros a Importar</h4>
        <div class="seleccion-opciones">
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              [(ngModel)]="todosSeleccionados"
              (change)="seleccionarTodos(todosSeleccionados)"
            />
            <span>Seleccionar todos ({{ registrosSeleccionados.size }} de {{ previewDatos?.total_filas }})</span>
          </label>
        </div>

        <!-- Tabla con selecci√≥n -->
        <div class="table-container">
          <table class="data-table selectable">
            <thead>
              <tr>
                <th>Sel.</th>
                <th>#</th>
                <th>Estado</th>
                <th *ngFor="let columna of columnasMapeadas.slice(0, 5)">{{ columna }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let fila of filasPaginadas" 
                  [class.error-row]="tieneError(fila._indice)"
                  [class.duplicate-row]="esDuplicado(fila._indice)">
                <td>
                  <input 
                    type="checkbox" 
                    [checked]="registrosSeleccionados.has(fila._indice)"
                    (change)="toggleSeleccion(fila._indice)"
                    [disabled]="tieneError(fila._indice)"
                  />
                </td>
                <td>{{ fila._indice + 1 }}</td>
                <td>
                  <span *ngIf="tieneError(fila._indice)" class="badge badge-error">Error</span>
                  <span *ngIf="esDuplicado(fila._indice) && !tieneError(fila._indice)" class="badge badge-warning">Duplicado</span>
                  <span *ngIf="!tieneError(fila._indice) && !esDuplicado(fila._indice)" class="badge badge-success">OK</span>
                </td>
                <td *ngFor="let columna of columnasMapeadas.slice(0, 5)">
                  {{ fila[columna] || '-' }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Selecci√≥n de comprador -->
      <div class="comprador-container">
        <h4>Asignar Comprador</h4>
        <div class="form-group">
          <label for="compradorSelect">Seleccione el comprador para estos env√≠os:</label>
          <select 
            id="compradorSelect" 
            [(ngModel)]="compradorId" 
            class="select-mapeo"
            [disabled]="cargandoCompradores">
            <option [ngValue]="null">Sin comprador</option>
            <option 
              *ngFor="let comprador of compradores" 
              [ngValue]="comprador.id">
              {{ comprador.nombre }} ({{ comprador.cedula }})
            </option>
          </select>
          <small *ngIf="cargandoCompradores">Cargando compradores...</small>
          <small *ngIf="!cargandoCompradores && compradores.length === 0">No hay compradores disponibles</small>
        </div>
      </div>

      <div class="acciones">
        <button class="btn btn-secondary" (click)="paso = 2">
          ‚Üê Atr√°s
        </button>
        <button 
          class="btn btn-primary" 
          (click)="procesarDatos()"
          [disabled]="registrosSeleccionados.size === 0 || cargando || cargandoCompradores">
          <span *ngIf="!cargando">Importar Datos ({{ registrosSeleccionados.size }} registros) ‚Üí</span>
          <span *ngIf="cargando">‚è≥ Importando...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- PASO 4: Completado -->
  <div *ngIf="paso === 4" class="paso-container">
    <div class="card success-card">
      <div class="success-icon">üéâ</div>
      <h3>¬°Importaci√≥n Completada con √âxito!</h3>
      
      <div *ngIf="importacionActual" class="resultado-container">
        <p class="resultado-mensaje">{{ importacionActual.mensaje_resultado }}</p>
        
        <div class="stats-grid">
          <div class="stat-card stat-success">
            <div class="stat-label">Registros Procesados</div>
            <div class="stat-value">{{ importacionActual.registros_procesados }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Porcentaje de √âxito</div>
            <div class="stat-value">{{ importacionActual.porcentaje_exito }}%</div>
          </div>
        </div>

        <div *ngIf="importacionActual.registros_errores > 0" class="alerta alerta-warning">
          ‚ö†Ô∏è Se encontraron {{ importacionActual.registros_errores }} errores durante la importaci√≥n.
          <button class="btn-link" (click)="descargarReporteErrores()">Descargar reporte de errores</button>
        </div>
      </div>

      <div class="acciones">
        <button class="btn btn-primary" (click)="reiniciar()">
          üîÑ Importar Otro Archivo
        </button>
        <button class="btn btn-secondary" routerLink="/dashboard">
          üè† Volver al Dashboard
        </button>
      </div>
    </div>
  </div>

  <!-- Loader -->
  <div *ngIf="cargando" class="loader-overlay">
    <div class="loader-spinner"></div>
    <p>Procesando...</p>
  </div>
</div>

