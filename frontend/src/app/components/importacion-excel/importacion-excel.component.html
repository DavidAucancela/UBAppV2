<div class="importacion-excel-container">
  <!-- Encabezado mejorado con estilo de otros m√≥dulos -->
  <div class="encabezado">
    <h1 class="titulo-principal">
      <i class="fas fa-file-excel"></i>
      Importaci√≥n de env√≠os
    </h1>
    <p class="subtitulo">Importe datos masivos de env√≠os desde archivos Excel con validaci√≥n y limpieza autom√°tica</p>
  </div>

  <!-- Mensajes de alerta -->
  <div *ngIf="mensajeError" class="alerta alerta-error">
    <span class="icono">‚ö†Ô∏è</span>
    <span>{{ mensajeError }}</span>
    <button class="btn-cerrar" (click)="mensajeError = ''">&times;</button>
  </div>

  <div *ngIf="mensajeExito" class="alerta alerta-exito">
    <span class="icono">‚úÖ</span>
    <span>{{ mensajeExito }}</span>
    <button class="btn-cerrar" (click)="mensajeExito = ''">&times;</button>
  </div>

  <!-- Indicador de progreso -->
  <div class="progress-steps">
    <div class="step" [class.active]="paso >= 1" [class.completed]="paso > 1">
      <div class="step-number">1</div>
      <div class="step-label">Cargar archivo</div>
    </div>
    <div class="step-line" [class.completed]="paso > 1"></div>
    <div class="step" [class.active]="paso >= 2" [class.completed]="paso > 2">
      <div class="step-number">2</div>
      <div class="step-label">Mapear columnas</div>
    </div>
    <div class="step-line" [class.completed]="paso > 2"></div>
    <div class="step" [class.active]="paso >= 3" [class.completed]="paso > 3">
      <div class="step-number">3</div>
      <div class="step-label">Validar y seleccionar</div>
    </div>
    <div class="step-line" [class.completed]="paso > 3"></div>
    <div class="step" [class.active]="paso >= 4">
      <div class="step-number">4</div>
      <div class="step-label">Procesar</div>
    </div>
  </div>

  <!-- PASO 1: Cargar Archivo -->
  <div *ngIf="paso === 1" class="paso-container">
    <div class="card">
      <h3>Cargar archivo</h3>
      
      <div class="upload-area">
        <input 
          type="file" 
          id="fileInput" 
          accept=".xlsx,.xls" 
          (change)="onArchivoSeleccionado($event)"
          #fileInput
        />
        <label for="fileInput" class="upload-label">
          <div class="upload-icon">üì§</div>
          <div class="upload-text">
            <strong>Haga clic para seleccionar</strong> o arrastre un archivo Excel
          </div>
          <div class="upload-hint">Formatos permitidos: .xlsx, .xls</div>
        </label>
      </div>

      <div *ngIf="archivoSeleccionado" class="archivo-info">
        <div class="archivo-nombre">
          <span class="icono">üìÑ</span>
          <span>{{ archivoSeleccionado.name }}</span>
        </div>
        <div class="archivo-tamano">
          {{ (archivoSeleccionado.size / 1024 / 1024).toFixed(2) }} MB
        </div>
      </div>

      <div *ngIf="previewDatos" class="preview-info">
        <h4>Vista previa de datos</h4>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total de filas</div>
            <div class="stat-value">{{ previewDatos.total_filas }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total de columnas</div>
            <div class="stat-value">{{ previewDatos.columnas.length }}</div>
          </div>
        </div>

        <!-- Tabla de vista previa -->
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>#</th>
                <th *ngFor="let columna of previewDatos.columnas">{{ columna }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let fila of filasPaginadas; let i = index">
                <td>{{ fila._indice + 1 }}</td>
                <td *ngFor="let columna of previewDatos.columnas">
                  {{ fila[columna] || '-' }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Paginaci√≥n -->
        <div *ngIf="totalPaginas > 1" class="paginacion">
          <button 
            (click)="paginaActual = paginaActual - 1" 
            [disabled]="paginaActual === 1"
            class="btn-paginacion">
            ‚Üê Anterior
          </button>
          <span class="pagina-info">P√°gina {{ paginaActual }} de {{ totalPaginas }}</span>
          <button 
            (click)="paginaActual = paginaActual + 1" 
            [disabled]="paginaActual === totalPaginas"
            class="btn-paginacion">
            Siguiente ‚Üí
          </button>
        </div>
      </div>

      <div class="acciones">
        <button class="btn btn-secondary" (click)="descargarPlantilla()">
          Descargar plantilla
        </button>
        <button 
          class="btn btn-primary" 
          (click)="subirArchivo()"
          [disabled]="!archivoSeleccionado || cargando">
          <span *ngIf="!cargando">Continuar</span>
          <span *ngIf="cargando">Procesando...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- PASO 2: Mapear Columnas -->
  <div *ngIf="paso === 2" class="paso-container">
    <div class="card">
      <h3>Mapear columnas del archivo</h3>
      <p>Asocie las columnas de su archivo Excel con los campos del sistema</p>

      <!-- Alerta cuando no hay columnas de consignatario -->
      <div *ngIf="mostrarSeleccionComprador && !tieneColumnasConsignatario" class="alerta alerta-warning">
        <span class="icono">‚ö†Ô∏è</span>
        <span>
          <strong>Archivo sin informaci√≥n de consignatario:</strong> 
          El archivo no contiene columnas de consignatario y RUC/C√©dula. 
          Debe seleccionar un comprador del sistema o crear uno nuevo para asignar los env√≠os.
        </span>
      </div>

      <div class="mapeo-container">
        <div class="mapeo-grid">
          <div *ngFor="let columna of previewDatos?.columnas" class="mapeo-item">
            <label>{{ columna }}</label>
            <select 
              [(ngModel)]="mapeoColumnas[columna]" 
              class="select-mapeo"
              (ngModelChange)="onMapeoCambiado()">
              <option [ngValue]="null">-- No mapear --</option>
              <option 
                *ngFor="let campo of camposDisponibles" 
                [ngValue]="campo.valor"
                [title]="campo.descripcion">
                {{ campo.etiqueta }} {{ campo.requerido ? '(*)' : '' }}
              </option>
            </select>
            <span class="campo-hint" *ngIf="mapeoColumnas[columna]">
              {{ obtenerDescripcionCampo(columna) }}
            </span>
          </div>
        </div>
      </div>

      <!-- Secci√≥n de selecci√≥n de comprador cuando no hay columnas de consignatario -->
      <div *ngIf="mostrarSeleccionComprador && !tieneColumnasConsignatario" class="seleccion-comprador-container">
        <h4>Asignar env√≠os a un comprador</h4>
        
        <!-- Modo selecci√≥n de usuario existente -->
        <div *ngIf="!modoCrearUsuario" class="seleccion-usuario">
          <label>
            <strong>Seleccionar comprador existente:</strong>
            <select 
              [(ngModel)]="compradorSeleccionadoId" 
              class="select-comprador"
              [ngModelOptions]="{standalone: true}">
              <option [ngValue]="null">-- Seleccione un comprador --</option>
              <option 
                *ngFor="let usuario of usuariosDisponibles" 
                [ngValue]="usuario.id">
                {{ usuario.nombre }} - {{ usuario.cedula }} {{ usuario.correo ? ' (' + usuario.correo + ')' : '' }}
              </option>
            </select>
          </label>
          
          <div class="acciones-comprador">
            <button 
              class="btn btn-secondary" 
              (click)="activarModoCrearUsuario()">
              ‚ûï Crear nuevo comprador
            </button>
          </div>
        </div>

        <!-- Modo crear nuevo usuario -->
        <div *ngIf="modoCrearUsuario" class="crear-usuario">
          <h5>Crear nuevo comprador</h5>
          <div class="form-grid">
            <label>
              Nombre completo <span class="required">*</span>
              <input 
                type="text" 
                [(ngModel)]="nuevoUsuario.nombre"
                [ngModelOptions]="{standalone: true}"
                placeholder="Nombre del comprador"
                required
              />
            </label>
            <label>
              C√©dula <span class="required">*</span>
              <input 
                type="text" 
                [(ngModel)]="nuevoUsuario.cedula"
                [ngModelOptions]="{standalone: true}"
                placeholder="1234567890"
                required
              />
            </label>
            <label>
              Correo electr√≥nico
              <input 
                type="email" 
                [(ngModel)]="nuevoUsuario.correo"
                [ngModelOptions]="{standalone: true}"
                placeholder="correo@ejemplo.com"
              />
            </label>
            <label>
              Tel√©fono
              <input 
                type="text" 
                [(ngModel)]="nuevoUsuario.telefono"
                [ngModelOptions]="{standalone: true}"
                placeholder="0999999999"
              />
            </label>
            <label class="full-row">
              Direcci√≥n
              <input 
                type="text" 
                [(ngModel)]="nuevoUsuario.direccion"
                [ngModelOptions]="{standalone: true}"
                placeholder="Direcci√≥n del comprador"
              />
            </label>
          </div>
          <div class="acciones-comprador">
            <button 
              class="btn btn-secondary" 
              (click)="cancelarCrearUsuario()">
              ‚Üê Volver a selecci√≥n
            </button>
          </div>
        </div>
      </div>

      <div class="acciones">
        <button class="btn btn-secondary" (click)="paso = 1">
          Atr√°s
        </button>
        <button 
          class="btn btn-primary" 
          (click)="validarDatos()"
          [disabled]="!mapeoValido || cargando || (mostrarSeleccionComprador && !compradorSeleccionadoId && !modoCrearUsuario)">
          <span *ngIf="!cargando">Validar </span>
          <span *ngIf="cargando">‚è≥ Validando...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- PASO 3: Validar y Seleccionar -->
  <div *ngIf="paso === 3" class="paso-container">
    <div class="card">
      <h3>Validar y seleccionar registros</h3>

      <!-- Estad√≠sticas de validaci√≥n -->
      <div *ngIf="importacionActual" class="stats-grid">
        <div class="stat-card stat-success">
          <div class="stat-label">Registros v√°lidos</div>
          <div class="stat-value">{{ importacionActual.registros_validos }}</div>
        </div>
        <div class="stat-card stat-error">
          <div class="stat-label">Registros con errores</div>
          <div class="stat-value">{{ importacionActual.registros_errores }}</div>
        </div>
        <div class="stat-card stat-warning">
          <div class="stat-label">Duplicados</div>
          <div class="stat-value">{{ importacionActual.registros_duplicados }}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total registros</div>
          <div class="stat-value">{{ importacionActual.total_registros }}</div>
        </div>
      </div>

      <!-- Errores de validaci√≥n -->
      <div *ngIf="erroresValidacion.length > 0" class="errores-container">
        <h4>Errores detectados</h4>
        <div class="errores-lista">
          <div *ngFor="let error of erroresValidacion.slice(0, 10)" class="error-item">
            <span class="error-fila">Fila {{ error.fila }}</span>
            <span class="error-columna">{{ error.columna }}</span>
            <span class="error-mensaje">{{ error.error }}</span>
          </div>
          <div *ngIf="erroresValidacion.length > 10" class="error-item more">
            ... y {{ erroresValidacion.length - 10 }} errores m√°s
          </div>
        </div>
        <button class="btn btn-secondary" (click)="descargarReporteErrores()">
          üì• Descargar reporte completo de errores
        </button> 
      </div>

      <!-- Selecci√≥n de registros -->
      <div class="seleccion-container">
        <h4>Seleccionar registros a importar</h4>
        <p class="info-text">
          Edite directamente los datos de producto antes de importarlos. Los cambios se aplicar√°n solo a los registros seleccionados.
        </p>
        <div class="seleccion-opciones">
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              [(ngModel)]="todosSeleccionados"
              (change)="seleccionarTodos(todosSeleccionados)"
            />
            <span>Seleccionar todos ({{ registrosSeleccionados.size }} de {{ previewDatos?.total_filas }})</span>
          </label>
        </div>

        <!-- Tabla con selecci√≥n -->
        <div class="table-container">
          <table class="data-table selectable">
            <thead>
              <tr>
                <th>Sel.</th>
                <th>#</th>
                <th>Estado</th>
                <th *ngIf="columnaHawb">HAWB</th>
                <th *ngIf="columnaConsignatario">Consignatario</th>
                <th *ngIf="columnaRuc">RUC / C√©dula</th>
                <th *ngIf="columnaDescripcion">Descripci√≥n Producto</th>
                <th *ngIf="columnaPesoProducto">Peso Producto (kg)</th>
                <th *ngIf="columnaCantidadProducto">Cantidad</th>
                <th *ngIf="columnaValorProducto">Valor (USD)</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let fila of filasPaginadas" 
                  [class.error-row]="tieneError(fila._indice)"
                  [class.duplicate-row]="esDuplicado(fila._indice)">
                <td>
                  <input 
                    type="checkbox" 
                    [checked]="registrosSeleccionados.has(fila._indice)"
                    (change)="toggleSeleccion(fila._indice)"
                    [disabled]="tieneError(fila._indice)"
                  />
                </td>
                <td>{{ fila._indice + 1 }}</td>
                <td>
                  <span *ngIf="tieneError(fila._indice)" class="badge badge-error">Error</span>
                  <span *ngIf="esDuplicado(fila._indice) && !tieneError(fila._indice)" class="badge badge-warning">Duplicado</span>
                  <span *ngIf="!tieneError(fila._indice) && !esDuplicado(fila._indice)" class="badge badge-success">OK</span>
                </td>
                <td *ngIf="columnaHawb as colHawb">
                  {{ fila[colHawb] !== undefined && fila[colHawb] !== null ? fila[colHawb] : '-' }}
                </td>
                <td *ngIf="columnaConsignatario as colConsignatario">
                  {{ fila[colConsignatario] !== undefined && fila[colConsignatario] !== null ? fila[colConsignatario] : '-' }}
                </td>
                <td *ngIf="columnaRuc as colRuc">
                  {{ fila[colRuc] !== undefined && fila[colRuc] !== null ? fila[colRuc] : '-' }}
                </td>
                <td *ngIf="columnaDescripcion as colDescripcion">
                  <input 
                    class="input-table"
                    type="text"
                    [(ngModel)]="fila[colDescripcion]"
                    [ngModelOptions]="{standalone: true}"
                    (ngModelChange)="registrarCambio(fila._indice, colDescripcion, $event)"
                  />
                </td>
                <td *ngIf="columnaPesoProducto as colPeso">
                  <input 
                    class="input-table"
                    type="number"
                    step="0.01"
                    [(ngModel)]="fila[colPeso]"
                    [ngModelOptions]="{standalone: true}"
                    (ngModelChange)="registrarCambio(fila._indice, colPeso, $event)"
                  />
                </td>
                <td *ngIf="columnaCantidadProducto as colCantidad">
                  <input 
                    class="input-table"
                    type="number"
                    step="1"
                    [(ngModel)]="fila[colCantidad]"
                    [ngModelOptions]="{standalone: true}"
                    (ngModelChange)="registrarCambio(fila._indice, colCantidad, $event)"
                  />
                </td>
                <td *ngIf="columnaValorProducto as colValor">
                  <input 
                    class="input-table"
                    type="number"
                    step="0.01"
                    [(ngModel)]="fila[colValor]"
                    [ngModelOptions]="{standalone: true}"
                    (ngModelChange)="registrarCambio(fila._indice, colValor, $event)"
                  />
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- Paginaci√≥n -->
        <div *ngIf="totalPaginas > 1" class="paginacion">
          <button 
            (click)="paginaActual = paginaActual - 1" 
            [disabled]="paginaActual === 1"
            class="btn-paginacion">
            ‚Üê Anterior
          </button>
          <span class="pagina-info">
            P√°gina {{ paginaActual }} de {{ totalPaginas }} 
            (Mostrando {{ (paginaActual - 1) * filasPorPagina + 1 }} - {{ Math.min(paginaActual * filasPorPagina, previewDatos?.total_filas || 0) }} de {{ previewDatos?.total_filas || 0 }} registros)
          </span>
          <button 
            (click)="paginaActual = paginaActual + 1" 
            [disabled]="paginaActual === totalPaginas"
            class="btn-paginacion">
            Siguiente ‚Üí
          </button>
        </div>
        
        <div *ngIf="columnaPesoProducto && !pesosCompletos" class="alerta alerta-warning">
          ‚ö†Ô∏è Debe ingresar el peso para todos los productos seleccionados antes de importar.
        </div>
      </div>

      <div class="acciones">
        <button class="btn btn-secondary" (click)="paso = 2">
          ‚Üê Atr√°s
        </button>
        <button 
          class="btn btn-primary" 
          (click)="procesarDatos()"
          [disabled]="registrosSeleccionados.size === 0 || cargando || !pesosCompletos">
          <span *ngIf="!cargando">Importar Datos ({{ registrosSeleccionados.size }} registros) ‚Üí</span>
          <span *ngIf="cargando">‚è≥ Importando...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- PASO 4: Completado -->
  <div *ngIf="paso === 4" class="paso-container">
    <div class="card success-card">
      <div class="success-icon">üéâ</div>
      <h3>¬°Importaci√≥n Completada con √âxito!</h3>
      
      <div *ngIf="importacionActual" class="resultado-container">
        <p class="resultado-mensaje">{{ importacionActual.mensaje_resultado }}</p>
        
        <div class="stats-grid">
          <div class="stat-card stat-success">
            <div class="stat-label">Registros Procesados</div>
            <div class="stat-value">{{ importacionActual.registros_procesados }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Porcentaje de √âxito</div>
            <div class="stat-value">{{ importacionActual.porcentaje_exito }}%</div>
          </div>
        </div>

        <div *ngIf="importacionActual.registros_errores > 0" class="alerta alerta-warning">
          ‚ö†Ô∏è Se encontraron {{ importacionActual.registros_errores }} errores durante la importaci√≥n.
          <button class="btn-link" (click)="descargarReporteErrores()">Descargar reporte de errores</button>
        </div>
      </div>

      <div *ngIf="compradoresPendientes.length > 0" class="compradores-pendientes">
        <h4>Completar datos de compradores creados</h4>
        <p>Estos compradores fueron generados autom√°ticamente a partir del consignatario. Complete su informaci√≥n de contacto.</p>

        <div class="comprador-form" *ngFor="let comprador of compradoresPendientes">
          <div class="comprador-form__header">
            <strong>{{ comprador.nombre || 'Sin nombre' }}</strong>
            <span>{{ comprador.cedula }}</span>
          </div>
          <div class="comprador-form__grid">
            <label>
              Correo electr√≥nico
              <input 
                type="email" 
                [(ngModel)]="comprador.correo" 
                [ngModelOptions]="{standalone: true}"
                placeholder="correo@ejemplo.com"
              />
            </label>
            <label>
              Tel√©fono
              <input 
                type="text" 
                [(ngModel)]="comprador.telefono" 
                [ngModelOptions]="{standalone: true}"
                placeholder="0999999999"
              />
            </label>
            <label class="full-row">
              Direcci√≥n
              <input 
                type="text" 
                [(ngModel)]="comprador.direccion" 
                [ngModelOptions]="{standalone: true}"
                placeholder="Direcci√≥n del comprador"
              />
            </label>
          </div>
          <div class="comprador-form__acciones">
            <button 
              class="btn btn-primary"
              (click)="guardarCompradorPendiente(comprador)"
              [disabled]="estadoCompradores[comprador.id || 0] === 'guardando'">
              <span *ngIf="estadoCompradores[comprador.id || 0] !== 'guardando'">Guardar datos</span>
              <span *ngIf="estadoCompradores[comprador.id || 0] === 'guardando'">Guardando...</span>
            </button>
            <span *ngIf="estadoCompradores[comprador.id || 0] === 'guardado'" class="badge badge-success">Datos guardados</span>
            <span *ngIf="estadoCompradores[comprador.id || 0] === 'error'" class="badge badge-error">Error al guardar</span>
          </div>
        </div>
      </div>

      <div class="acciones">
        <button class="btn btn-primary" (click)="reiniciar()">
          üîÑ Cargar otro archivo
        </button>
        <button class="btn btn-secondary" routerLink="/inicio">
          üè† Inicio
        </button>
      </div>
    </div>
  </div>

  <!-- Loader -->
  <div *ngIf="cargando" class="loader-overlay">
    <div class="loader-spinner"></div>
    <p>Procesando...</p>
  </div>
</div>

