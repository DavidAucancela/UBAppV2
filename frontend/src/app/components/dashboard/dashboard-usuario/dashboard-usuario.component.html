<div class="dashboard-container">
  <!-- Loading y Error -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner-wrapper">
      <i class="fas fa-spinner fa-spin"></i>
      <p class="loading-text">Cargando estadísticas...</p>
    </div>
  </div>

  <div *ngIf="error" class="error-alert">
    <i class="fas fa-exclamation-circle"></i>
    {{ error }}
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!loading && dashboard" class="dashboard-content">
    <!-- Header -->
    <header class="dashboard-header">
      <div class="header-content">
        <div>
          <h1 class="dashboard-title">
            <i class="fas fa-user-circle"></i>
            Mi Panel
          </h1>
          <p class="dashboard-subtitle">Resumen de tus envíos y estadísticas</p>
        </div>
        <button class="btn-refresh" (click)="cargarDashboard()" title="Actualizar">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
    </header>

    <!-- KPIs Principales -->
    <section class="kpis-section">
      <div class="kpis-grid">
        <div class="kpi-card kpi-primary">
          <div class="kpi-icon">
            <i class="fas fa-box"></i>
          </div>
          <div class="kpi-content">
            <h3 class="kpi-label">Total Envíos</h3>
            <p class="kpi-value">{{ dashboard.total_envios || 0 }}</p>
          </div>
        </div>
        <div class="kpi-card kpi-warning">
          <div class="kpi-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="kpi-content">
            <h3 class="kpi-label">Pendientes</h3>
            <p class="kpi-value">{{ dashboard.envios_pendientes || 0 }}</p>
          </div>
        </div>
        <div class="kpi-card kpi-info">
          <div class="kpi-icon">
            <i class="fas fa-truck"></i>
          </div>
          <div class="kpi-content">
            <h3 class="kpi-label">En Tránsito</h3>
            <p class="kpi-value">{{ dashboard.envios_en_transito || 0 }}</p>
          </div>
        </div>
        <div class="kpi-card kpi-success">
          <div class="kpi-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="kpi-content">
            <h3 class="kpi-label">Entregados</h3>
            <p class="kpi-value">{{ dashboard.envios_entregados || 0 }}</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Cupo Anual -->
    <section class="cupo-section" *ngIf="authService.isComprador()">
      <div class="card cupo-card">
        <div class="cupo-header">
          <div>
            <h2 class="card-title">
              <i class="fas fa-chart-line"></i>
              Cupo Anual {{ anioActual }}
            </h2>
            <p class="card-subtitle">Consumo de tu cupo disponible</p>
          </div>
        </div>
        <div class="cupo-body">
          <div class="cupo-progress-wrapper">
            <div class="cupo-progress-bar">
              <div 
                class="cupo-progress-fill"
                [class.cupo-low]="(dashboard.porcentaje_usado || 0) < 50"
                [class.cupo-medium]="(dashboard.porcentaje_usado || 0) >= 50 && (dashboard.porcentaje_usado || 0) < 80"
                [class.cupo-high]="(dashboard.porcentaje_usado || 0) >= 80 && (dashboard.porcentaje_usado || 0) < 90"
                [class.cupo-critical]="(dashboard.porcentaje_usado || 0) >= 90"
                [style.width.%]="dashboard.porcentaje_usado || 0">
              </div>
            </div>
            <div class="cupo-percentage">
              <span class="cupo-percentage-value">{{ (dashboard.porcentaje_usado || 0) | number:'1.0-0' }}%</span>
              <span class="cupo-percentage-label">utilizado</span>
            </div>
          </div>
          <div class="cupo-stats">
            <div class="cupo-stat">
              <span class="cupo-stat-label">Usado</span>
              <span class="cupo-stat-value">{{ (dashboard.peso_usado || 0) | number:'1.2-2' }} kg</span>
            </div>
            <div class="cupo-stat">
              <span class="cupo-stat-label">Disponible</span>
              <span class="cupo-stat-value">{{ (dashboard.peso_disponible || 0) | number:'1.2-2' }} kg</span>
            </div>
            <div class="cupo-stat">
              <span class="cupo-stat-label">Total</span>
              <span class="cupo-stat-value">{{ (dashboard.cupo_anual || 0) | number:'1.2-2' }} kg</span>
            </div>
          </div>
          <div *ngIf="(dashboard.porcentaje_usado || 0) >= 80" class="cupo-alert">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Has utilizado el {{ (dashboard.porcentaje_usado || 0) | number:'1.0-0' }}% de tu cupo anual</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Layout Principal: Gráfico y Envíos Recientes -->
    <section class="main-content-section">
      <!-- Gráfico de Estados -->
      <div class="card chart-card">
        <div class="card-header">
          <h2 class="card-title">
            <i class="fas fa-chart-pie"></i>
            Distribución por Estado
          </h2>
        </div>
        <div class="chart-body">
          <canvas #estadosChart></canvas>
        </div>
      </div>

      <!-- Envíos Recientes -->
      <div class="card envios-recientes-card">
        <div class="card-header">
          <h2 class="card-title">
            <i class="fas fa-history"></i>
            Envíos Recientes
          </h2>
          <a routerLink="/mis-envios" class="view-all-link">
            Ver todos
            <i class="fas fa-arrow-right"></i>
          </a>
        </div>
        <div class="envios-list">
          <div 
            *ngFor="let envio of enviosRecientes.slice(0, 5)"
            class="envio-item"
            [routerLink]="['/mis-envios']">
            <div class="envio-icon" [ngClass]="'status-' + obtenerClaseEstado(envio.estado).split(' ')[1]">
              <i class="fas fa-truck"></i>
            </div>
            <div class="envio-content">
              <span class="envio-hawb">{{ envio.hawb }}</span>
              <span class="envio-meta">{{ obtenerEstadoEnvio(envio.estado) }}</span>
            </div>
            <i class="fas fa-chevron-right envio-arrow"></i>
          </div>
          <div *ngIf="!enviosRecientes || enviosRecientes.length === 0" class="envios-empty">
            <i class="fas fa-inbox"></i>
            <span>No hay envíos recientes</span>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>
