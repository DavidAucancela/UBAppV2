<div class="dashboard-container">
  <!-- Vista Analytics -->
  <div class="analytics-view">
    <div class="analytics-container">
      <!-- Header con controles -->
      <div class="analytics-header">
        <div class="header-content">
          <h1><i class="fas fa-chart-line"></i> Analytics Dashboard</h1>
          <p>Visualización avanzada de datos y análisis de tendencias</p>
        </div>
        <div class="header-actions">
          <button class="btn btn-secondary" (click)="exportData('pdf')">
            <i class="fas fa-file-pdf"></i> Exportar PDF
          </button>
          <button class="btn btn-secondary" (click)="exportData('excel')">
            <i class="fas fa-file-excel"></i> Exportar Excel
          </button>
          <button class="btn btn-secondary" (click)="resetFilters()">
            <i class="fas fa-redo"></i> Resetear
          </button>
        </div>
      </div>

      <!-- Panel de filtros y categorías -->
      <div class="filters-panel">
        <div class="filter-group">
          <label><i class="fas fa-calendar"></i> Período</label>
          <select [(ngModel)]="filters.periodo" (change)="onFilterChange()" class="filter-select">
            <option *ngFor="let periodo of periodos" [value]="periodo.value">
              {{ periodo.label }}
            </option>
          </select>
        </div>

        <div class="filter-group">
          <label><i class="fas fa-chart-bar"></i> Tipo de gráfico</label>
          <div class="chart-type-buttons">
            <button 
              *ngFor="let tipo of tiposGrafico" 
              [class.active]="filters.tipoGrafico === tipo.value"
              (click)="filters.tipoGrafico = tipo.value; onFilterChange()"
              class="chart-type-btn"
              [title]="tipo.label">
              <i class="fas" [ngClass]="tipo.icon"></i>
            </button>
          </div>
        </div>

        <div class="filter-group">
          <label><i class="fas fa-filter"></i> Métrica</label>
          <div class="metric-buttons">
            <button 
              *ngFor="let metrica of metricas"
              [class.active]="filters.metrica === metrica.value"
              (click)="filters.metrica = metrica.value; onFilterChange()"
              class="metric-btn">
              <i class="fas" [ngClass]="metrica.icon"></i>
              {{ metrica.label }}
            </button>
          </div>
        </div>
      </div>

      <!-- Botones de categorías -->
      <div class="category-buttons" *ngIf="mostrarTodasLasTarjetas">
        <button 
          class="category-btn"
          [class.active]="categoriaSeleccionada === 'kpis'"
          (click)="seleccionarCategoria('kpis')">
          <i class="fas fa-tachometer-alt"></i> KPIs
        </button>
        <button 
          class="category-btn"
          [class.active]="categoriaSeleccionada === 'graficos'"
          (click)="seleccionarCategoria('graficos')">
          <i class="fas fa-chart-bar"></i> Gráficos
        </button>
        <button 
          class="category-btn"
          [class.active]="categoriaSeleccionada === 'estadisticas'"
          (click)="seleccionarCategoria('estadisticas')">
          <i class="fas fa-chart-pie"></i> Estadísticas
        </button>
      </div>

      <!-- Sección KPIs -->
      <div class="category-section" *ngIf="mostrarCategoria('kpis')">
        <div class="section-title">
          <h2><i class="fas fa-tachometer-alt"></i> Indicadores Clave de Rendimiento</h2>
        </div>
        <div class="kpis-section">
          <div class="kpi-card">
            <div class="kpi-icon success">
              <i class="fas fa-truck"></i>
            </div>
            <div class="kpi-content">
              <h3>{{ kpis.totalEnvios }}</h3>
              <p>Total Envíos</p>
              <span class="kpi-trend positive" *ngIf="kpis.tasaCrecimiento > 0">
                <i class="fas fa-arrow-up"></i> {{ kpis.tasaCrecimiento | number:'1.1-1' }}%
              </span>
              <span class="kpi-trend negative" *ngIf="kpis.tasaCrecimiento < 0">
                <i class="fas fa-arrow-down"></i> {{ kpis.tasaCrecimiento | number:'1.1-1' }}%
              </span>
            </div>
          </div>

          <div class="kpi-card">
            <div class="kpi-icon warning">
              <i class="fas fa-clock"></i>
            </div>
            <div class="kpi-content">
              <h3>{{ kpis.enviosPendientes }}</h3>
              <p>Envíos Pendientes</p>
              <span class="kpi-badge">Requiere atención</span>
            </div>
          </div>

          <div class="kpi-card">
            <div class="kpi-icon info">
              <i class="fas fa-box"></i>
            </div>
            <div class="kpi-content">
              <h3>{{ kpis.totalProductos }}</h3>
              <p>Total Productos</p>
            </div>
          </div>

          <div class="kpi-card">
            <div class="kpi-icon info">
              <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="kpi-content">
              <h3>${{ kpis.valorPromedio | number:'1.2-2' }}</h3>
              <p>Valor Promedio</p>
            </div>
          </div>

          <div class="kpi-card">
            <div class="kpi-icon success">
              <i class="fas fa-star"></i>
            </div>
            <div class="kpi-content">
              <h3>{{ kpis.satisfaccionCliente | number:'1.1-1' }}%</h3>
              <p>Satisfacción Cliente</p>
              <span class="kpi-badge success">Excelente</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Sección Gráficos -->
      <div class="category-section" *ngIf="mostrarCategoria('graficos')">
        <div class="section-title">
          <h2><i class="fas fa-chart-bar"></i> Visualizaciones y Análisis</h2>
        </div>
        <div class="charts-grid">
          <!-- Gráfico principal de envíos -->
          <div class="chart-container large" [class.fullscreen]="isFullscreen('envios')">
            <div class="chart-header">
              <h2><i class="fas fa-truck"></i> Evolución de Envíos</h2>
              <div class="chart-actions">
                <button class="icon-btn" title="Descargar" (click)="downloadChart('envios')">
                  <i class="fas fa-download"></i>
                </button>
                <button class="icon-btn" title="Pantalla completa" (click)="toggleFullscreen('envios')">
                  <i class="fas" [ngClass]="isFullscreen('envios') ? 'fa-compress' : 'fa-expand'"></i>
                </button>
              </div>
            </div>
            <div class="chart-body">
              <canvas #enviosChart></canvas>
            </div>
          </div>

          <!-- Gráfico de distribución por estados -->
          <div class="chart-container medium" [class.fullscreen]="isFullscreen('estados')">
            <div class="chart-header">
              <h2><i class="fas fa-chart-pie"></i> Estados de Envíos</h2>
              <div class="chart-actions">
                <button class="icon-btn" title="Descargar" (click)="downloadChart('estados')">
                  <i class="fas fa-download"></i>
                </button>
                <button class="icon-btn" title="Pantalla completa" (click)="toggleFullscreen('estados')">
                  <i class="fas" [ngClass]="isFullscreen('estados') ? 'fa-compress' : 'fa-expand'"></i>
                </button>
              </div>
            </div>
            <div class="chart-body">
              <canvas #estadosChart></canvas>
            </div>
          </div>

          <!-- Gráfico de productos por categoría -->
          <div class="chart-container medium" [class.fullscreen]="isFullscreen('productos')">
            <div class="chart-header">
              <h2><i class="fas fa-box"></i> Productos por Categoría</h2>
              <div class="chart-actions">
                <button class="icon-btn" title="Descargar" (click)="downloadChart('productos')">
                  <i class="fas fa-download"></i>
                </button>
                <button class="icon-btn" title="Pantalla completa" (click)="toggleFullscreen('productos')">
                  <i class="fas" [ngClass]="isFullscreen('productos') ? 'fa-compress' : 'fa-expand'"></i>
                </button>
              </div>
            </div>
            <div class="chart-body">
              <canvas #productosChart></canvas>
            </div>
          </div>

          <!-- Gráfico de tendencias y proyección -->
          <div class="chart-container large" [class.fullscreen]="isFullscreen('tendencias')">
            <div class="chart-header">
              <h2><i class="fas fa-chart-area"></i> Análisis de Tendencias</h2>
              <div class="chart-actions">
                <button class="icon-btn" title="Descargar" (click)="downloadChart('tendencias')">
                  <i class="fas fa-download"></i>
                </button>
                <button class="icon-btn" title="Pantalla completa" (click)="toggleFullscreen('tendencias')">
                  <i class="fas" [ngClass]="isFullscreen('tendencias') ? 'fa-compress' : 'fa-expand'"></i>
                </button>
              </div>
            </div>
            <div class="chart-body">
              <canvas #tendenciasChart></canvas>
            </div>
          </div>

          <!-- Gráfico radar de rendimiento -->
          <div class="chart-container medium" [class.fullscreen]="isFullscreen('categorias')">
            <div class="chart-header">
              <h2><i class="fas fa-chart-area"></i> Rendimiento Multidimensional</h2>
              <div class="chart-actions">
                <button class="icon-btn" title="Descargar" (click)="downloadChart('categorias')">
                  <i class="fas fa-download"></i>
                </button>
                <button class="icon-btn" title="Pantalla completa" (click)="toggleFullscreen('categorias')">
                  <i class="fas" [ngClass]="isFullscreen('categorias') ? 'fa-compress' : 'fa-expand'"></i>
                </button>
              </div>
            </div>
            <div class="chart-body">
              <canvas #categoriasChart></canvas>
            </div>
          </div>

          <!-- Gráfico de KPIs -->
          <div class="chart-container medium" [class.fullscreen]="isFullscreen('kpi')">
            <div class="chart-header">
              <h2><i class="fas fa-tachometer-alt"></i> Indicadores Clave</h2>
              <div class="chart-actions">
                <button class="icon-btn" title="Descargar" (click)="downloadChart('kpi')">
                  <i class="fas fa-download"></i>
                </button>
                <button class="icon-btn" title="Pantalla completa" (click)="toggleFullscreen('kpi')">
                  <i class="fas" [ngClass]="isFullscreen('kpi') ? 'fa-compress' : 'fa-expand'"></i>
                </button>
              </div>
            </div>
            <div class="chart-body">
              <canvas #kpiChart></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Sección Estadísticas -->
      <div class="category-section" *ngIf="mostrarCategoria('estadisticas')">
        <div class="section-title">
          <h2><i class="fas fa-chart-pie"></i> Estadísticas Detalladas</h2>
        </div>

        <!-- Estadísticas de Notificaciones -->
        <div class="stats-subsection">
          <h3><i class="fas fa-bell"></i> Notificaciones</h3>
          <div class="kpis-section">
            <div class="kpi-card">
              <div class="kpi-icon primary">
                <i class="fas fa-bell"></i>
              </div>
              <div class="kpi-content">
                <h3>{{ notificacionesStats.total }}</h3>
                <p>Total Notificaciones</p>
              </div>
            </div>

            <div class="kpi-card">
              <div class="kpi-icon warning">
                <i class="fas fa-envelope"></i>
              </div>
              <div class="kpi-content">
                <h3>{{ notificacionesStats.noLeidas }}</h3>
                <p>No Leídas</p>
                <span class="kpi-badge" *ngIf="notificacionesStats.noLeidas > 0">Nuevas</span>
              </div>
            </div>

            <div class="kpi-card" *ngFor="let tipo of getNotificacionesTipos()">
              <div class="kpi-icon info">
                <i class="fas" [ngClass]="getNotificacionIcon(tipo)"></i>
              </div>
              <div class="kpi-content">
                <h3>{{ notificacionesStats.porTipo[tipo] || 0 }}</h3>
                <p>{{ getNotificacionLabel(tipo) }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Estadísticas de Consultas Semánticas -->
        <div class="stats-subsection">
          <h3><i class="fas fa-brain"></i> Consultas Semánticas</h3>
          <div class="kpis-section">
            <div class="kpi-card">
              <div class="kpi-icon gradient">
                <i class="fas fa-search"></i>
              </div>
              <div class="kpi-content">
                <h3>{{ semanticasStats.totalConsultas }}</h3>
                <p>Total Consultas</p>
              </div>
            </div>

            <div class="kpi-card">
              <div class="kpi-icon primary">
                <i class="fas fa-vector-square"></i>
              </div>
              <div class="kpi-content">
                <h3>{{ semanticasStats.totalEmbeddings }}</h3>
                <p>Embeddings Generados</p>
              </div>
            </div>

            <div class="kpi-card">
              <div class="kpi-icon info">
                <i class="fas fa-coins"></i>
              </div>
              <div class="kpi-content">
                <h3>{{ semanticasStats.totalTokens | number:'1.0-0' }}</h3>
                <p>Tokens Usados</p>
              </div>
            </div>

            <div class="kpi-card">
              <div class="kpi-icon success">
                <i class="fas fa-database"></i>
              </div>
              <div class="kpi-content">
                <h3>{{ semanticasStats.datosVectorizados }}</h3>
                <p>Datos Vectorizados</p>
              </div>
            </div>

            <div class="kpi-card">
              <div class="kpi-icon warning">
                <i class="fas fa-clock"></i>
              </div>
              <div class="kpi-content">
                <h3>{{ semanticasStats.promedioTiempoRespuesta | number:'1.0-0' }}ms</h3>
                <p>Tiempo Promedio</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Estadísticas Geográficas -->
        <div class="stats-subsection">
          <h3><i class="fas fa-map-marked-alt"></i> Distribución Geográfica</h3>
          <div class="kpis-section">
            <div class="kpi-card">
              <div class="kpi-icon success">
                <i class="fas fa-map"></i>
              </div>
              <div class="kpi-content">
                <h3>{{ geograficasStats.totalConUbicacion }}</h3>
                <p>Usuarios con Ubicación</p>
              </div>
            </div>

            <div class="kpi-card">
              <div class="kpi-icon info">
                <i class="fas fa-globe-americas"></i>
              </div>
              <div class="kpi-content">
                <h3>{{ getTotalProvincias() }}</h3>
                <p>Provincias</p>
              </div>
            </div>

            <div class="kpi-card">
              <div class="kpi-icon primary">
                <i class="fas fa-city"></i>
              </div>
              <div class="kpi-content">
                <h3>{{ getTotalCantones() }}</h3>
                <p>Cantones</p>
              </div>
            </div>

            <div class="kpi-card">
              <div class="kpi-icon gradient">
                <i class="fas fa-building"></i>
              </div>
              <div class="kpi-content">
                <h3>{{ getTotalCiudades() }}</h3>
                <p>Ciudades</p>
              </div>
            </div>
          </div>

          <!-- Top Provincias -->
          <div class="top-locations" *ngIf="getTopProvincias().length > 0">
            <h4><i class="fas fa-trophy"></i> Top Provincias</h4>
            <div class="location-list">
              <div class="location-item" *ngFor="let prov of getTopProvincias()">
                <span class="location-name">{{ prov.nombre }}</span>
                <span class="location-count">{{ prov.cantidad }} usuarios</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer con timestamp -->
      <div class="analytics-footer">
        <p>
          <i class="fas fa-clock"></i>
          Última actualización: {{ ultimaActualizacion | date:'medium':'':'es-ES' }}
        </p>
      </div>
    </div>
  </div>

  <!-- Overlay de exportación -->
  <div class="exporting-overlay" *ngIf="exportingData">
    <div class="exporting-content">
      <i class="fas fa-spinner fa-spin"></i>
      <h3>Exportando datos...</h3>
      <p>Por favor espera mientras se genera el archivo</p>
    </div>
  </div>
</div>
