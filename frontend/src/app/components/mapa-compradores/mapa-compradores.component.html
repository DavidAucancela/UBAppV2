<div class="mapa-container">
  <div class="mapa-header">
    <br>
    <br>
    <br>
    <h1>Mapa de Compradores</h1>
    <p class="mapa-descripcion">
    </p>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="spinner"></div>
    <p>Cargando mapa...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-message">
    <span class="error-icon">âš ï¸</span>
    <p>{{ error }}</p>
    <button (click)="recargarDatos()" class="btn-retry">Reintentar</button>
  </div>

  <!-- EstadÃ­sticas -->
  <div *ngIf="mapaData && !loading" class="estadisticas-panel">
    <div class="estadistica-card">
      <div class="estadistica-icon">ğŸ‘¥</div>
      <div class="estadistica-info">
        <span class="estadistica-valor">{{ mapaData.total_compradores }}</span>
        <span class="estadistica-label">Compradores Totales</span>
      </div>
    </div>
    
    <div class="estadistica-card">
      <div class="estadistica-icon">ğŸ“</div>
      <div class="estadistica-info">
        <span class="estadistica-valor">{{ mapaData.provincias.length }}</span>
        <span class="estadistica-label">Provincias con Compradores</span>
      </div>
    </div>

    <div *ngIf="provinciaSeleccionada" class="estadistica-card provincia-activa">
      <div class="estadistica-icon">ğŸ¯</div>
      <div class="estadistica-info">
        <span class="estadistica-valor">{{ provinciaSeleccionada }}</span>
        <span class="estadistica-label">Provincia Seleccionada</span>
      </div>
    </div>
  </div>

  <!-- Controles del Mapa -->
  <div *ngIf="!loading" class="mapa-controles">
    <button (click)="volverVista()" class="btn-control" title="Volver a vista general">
      ğŸ  Vista General
    </button>
  </div>

  <!-- Mapa y Panel Lateral -->
  <div *ngIf="!loading && !error && isBrowser" class="mapa-layout">
    <!-- Mapa -->
    <div class="mapa-wrapper">
      <div id="mapa-ecuador" class="mapa-leaflet"></div>
    </div>
    
    <!-- Panel de Instrucciones (Lado Derecho) -->
    <div class="instrucciones-panel">
      <h4>ğŸ’¡ CÃ³mo usar el mapa</h4>
      <ol>
        <li>Haz clic en un marcador de provincia (ğŸ“) para ver los compradores</li>
        <li>Usa la rueda del mouse para hacer zoom</li>
        <li>Arrastra el mapa para moverte por Ecuador</li>
        <li>Haz clic en un comprador (ğŸ‘¤) para ver sus envÃ­os</li>
      </ol>
    </div>
  </div>

  <!-- Lista de Compradores (Parte Inferior) -->
  <div *ngIf="provinciaSeleccionada && compradoresProvinciaSeleccionada.length > 0" class="compradores-lista">
    <div class="compradores-header">
      <h3>
        <span class="provincia-icon">ğŸ“</span>
        Compradores en {{ provinciaSeleccionada }}
        <span class="badge-compradores">{{ compradoresProvinciaSeleccionada.length }}</span>
      </h3>
      <button (click)="volverVista()" class="btn-cerrar">âœ• Cerrar</button>
    </div>
    <div class="compradores-grid">
      <div class="comprador-card" *ngFor="let comprador of compradoresProvinciaSeleccionada">
        <div class="comprador-card-header">
          <h4>ğŸ‘¤ {{ comprador.nombre }}</h4>
          <span class="badge-envios">{{ comprador.total_envios }} envÃ­os</span>
        </div>
        <div class="comprador-info">
          <p><strong>Usuario:</strong> {{ comprador.username }}</p>
          <p><strong>Email:</strong> {{ comprador.correo }}</p>
          <p *ngIf="comprador.telefono"><strong>TelÃ©fono:</strong> {{ comprador.telefono }}</p>
          <p><strong>UbicaciÃ³n:</strong> {{ comprador.ubicacion_completa }}</p>
        </div>
        <div *ngIf="comprador.envios_recientes.length > 0" class="comprador-envios">
          <h5>ğŸ“¦ EnvÃ­os Recientes</h5>
          <div class="envios-lista">
            <div class="envio-item" *ngFor="let envio of comprador.envios_recientes.slice(0, 3)">
              <div class="envio-header">
                <span class="envio-hawb"><strong>HAWB:</strong> {{ envio.hawb }}</span>
                <span class="estado-badge" [ngClass]="'estado-' + envio.estado">
                  {{ getEstadoDisplay(envio.estado) }}
                </span>
              </div>
              <div class="envio-details">
                <span>Peso: {{ envio.peso_total }} kg</span>
                <span>Valor: ${{ envio.valor_total }}</span>
                <span>Costo: ${{ envio.costo_servicio }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista de Provincias - Vista Mosaico -->
  <div *ngIf="mapaData && !loading" class="provincias-lista">
    <h3>ğŸ“Š Resumen por Provincia</h3>
    <div class="provincias-grid">
      <div class="provincia-card" *ngFor="let provincia of mapaData.provincias">
        <div class="provincia-header">
          <h4>{{ provincia.provincia }}</h4>
          <span class="badge-compradores">{{ provincia.total_compradores }}</span>
        </div>
        <div class="provincia-compradores">
          <div class="comprador-mini" *ngFor="let comprador of provincia.compradores.slice(0, 3)">
            <span class="comprador-nombre">{{ comprador.nombre }}</span>
            <span class="comprador-envios">{{ comprador.total_envios }}</span>
          </div>
          <p *ngIf="provincia.compradores.length > 3" class="mas-compradores">
            + {{ provincia.compradores.length - 3 }} compradores mÃ¡s
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
