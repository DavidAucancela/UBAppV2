<div class="change-password-container">
  <div class="change-password-card">
    <div class="header">
      <div class="icon" [class.warning]="mustChange">
        <i class="fas" [class.fa-exclamation-triangle]="mustChange" [class.fa-key]="!mustChange"></i>
      </div>
      <h2>{{ mustChange ? 'Cambio de Contraseña Obligatorio' : 'Cambiar Contraseña' }}</h2>
      <p *ngIf="mustChange" class="warning-message">
        Por políticas de seguridad, debes cambiar tu contraseña antes de continuar.
      </p>
      <p *ngIf="!mustChange">
        Actualiza tu contraseña para mantener tu cuenta segura.
      </p>
    </div>

    <form [formGroup]="passwordForm" (ngSubmit)="onSubmit()" class="password-form">
      <!-- Contraseña actual -->
      <div class="form-group">
        <label for="password_actual">Contraseña Actual *</label>
        <div class="password-input">
          <span class="input-icon">
            <i class="fas fa-lock"></i>
          </span>
          <input 
            [type]="hideCurrentPassword ? 'password' : 'text'"
            id="password_actual"
            formControlName="password_actual" 
            class="form-control"
            placeholder="Ingresa tu contraseña actual"
            [class.error]="passwordForm.get('password_actual')?.invalid && passwordForm.get('password_actual')?.touched"
          >
          <button 
            type="button" 
            class="password-toggle"
            (click)="hideCurrentPassword = !hideCurrentPassword"
          >
            <i class="fas" [class.fa-eye]="!hideCurrentPassword" [class.fa-eye-slash]="hideCurrentPassword"></i>
          </button>
        </div>
        <div class="error-message" *ngIf="passwordForm.get('password_actual')?.invalid && passwordForm.get('password_actual')?.touched">
          La contraseña actual es requerida
        </div>
      </div>

      <!-- Nueva contraseña -->
      <div class="form-group">
        <label for="password_nuevo">Nueva Contraseña *</label>
        <div class="password-input">
          <span class="input-icon">
            <i class="fas fa-key"></i>
          </span>
          <input 
            [type]="hideNewPassword ? 'password' : 'text'"
            id="password_nuevo"
            formControlName="password_nuevo" 
            class="form-control"
            placeholder="Ingresa tu nueva contraseña"
            [class.error]="passwordForm.get('password_nuevo')?.invalid && passwordForm.get('password_nuevo')?.touched"
          >
          <button 
            type="button" 
            class="password-toggle"
            (click)="hideNewPassword = !hideNewPassword"
          >
            <i class="fas" [class.fa-eye]="!hideNewPassword" [class.fa-eye-slash]="hideNewPassword"></i>
          </button>
        </div>
        
        <!-- Indicador de fuerza de contraseña -->
        <div class="password-strength" *ngIf="passwordForm.get('password_nuevo')?.value">
          <h4>Requisitos de seguridad:</h4>
          <div class="strength-grid">
            <div class="requirement" [class.valid]="passwordStrength.hasMinLength">
              <i class="fas" [class.fa-check-circle]="passwordStrength.hasMinLength" 
                 [class.fa-times-circle]="!passwordStrength.hasMinLength"></i>
              <span>Mínimo 8 caracteres</span>
            </div>
            <div class="requirement" [class.valid]="passwordStrength.hasUpperCase">
              <i class="fas" [class.fa-check-circle]="passwordStrength.hasUpperCase" 
                 [class.fa-times-circle]="!passwordStrength.hasUpperCase"></i>
              <span>Una mayúscula (A-Z)</span>
            </div>
            <div class="requirement" [class.valid]="passwordStrength.hasLowerCase">
              <i class="fas" [class.fa-check-circle]="passwordStrength.hasLowerCase" 
                 [class.fa-times-circle]="!passwordStrength.hasLowerCase"></i>
              <span>Una minúscula (a-z)</span>
            </div>
            <div class="requirement" [class.valid]="passwordStrength.hasNumber">
              <i class="fas" [class.fa-check-circle]="passwordStrength.hasNumber" 
                 [class.fa-times-circle]="!passwordStrength.hasNumber"></i>
              <span>Un número (0-9)</span>
            </div>
            <div class="requirement" [class.valid]="passwordStrength.hasSpecial">
              <i class="fas" [class.fa-check-circle]="passwordStrength.hasSpecial" 
                 [class.fa-times-circle]="!passwordStrength.hasSpecial"></i>
              <span>Un carácter especial</span>
            </div>
          </div>
          
          <!-- Barra de progreso de fuerza -->
          <div class="strength-bar">
            <div class="strength-level" 
                 [style.width.%]="(([passwordStrength.hasMinLength, passwordStrength.hasUpperCase, passwordStrength.hasLowerCase, passwordStrength.hasNumber, passwordStrength.hasSpecial].filter(x => x).length) * 20)"
                 [class.weak]="([passwordStrength.hasMinLength, passwordStrength.hasUpperCase, passwordStrength.hasLowerCase, passwordStrength.hasNumber, passwordStrength.hasSpecial].filter(x => x).length) <= 2"
                 [class.medium]="([passwordStrength.hasMinLength, passwordStrength.hasUpperCase, passwordStrength.hasLowerCase, passwordStrength.hasNumber, passwordStrength.hasSpecial].filter(x => x).length) === 3 || ([passwordStrength.hasMinLength, passwordStrength.hasUpperCase, passwordStrength.hasLowerCase, passwordStrength.hasNumber, passwordStrength.hasSpecial].filter(x => x).length) === 4"
                 [class.strong]="passwordStrength.isValid">
            </div>
          </div>
          <div class="strength-text">
            <span *ngIf="!passwordStrength.isValid && ([passwordStrength.hasMinLength, passwordStrength.hasUpperCase, passwordStrength.hasLowerCase, passwordStrength.hasNumber, passwordStrength.hasSpecial].filter(x => x).length) <= 2" class="weak">
              Contraseña débil
            </span>
            <span *ngIf="!passwordStrength.isValid && ([passwordStrength.hasMinLength, passwordStrength.hasUpperCase, passwordStrength.hasLowerCase, passwordStrength.hasNumber, passwordStrength.hasSpecial].filter(x => x).length) > 2" class="medium">
              Contraseña media
            </span>
            <span *ngIf="passwordStrength.isValid" class="strong">
              Contraseña fuerte
            </span>
          </div>
        </div>
      </div>

      <!-- Confirmar contraseña -->
      <div class="form-group">
        <label for="password_confirm">Confirmar Nueva Contraseña *</label>
        <div class="password-input">
          <span class="input-icon">
            <i class="fas fa-check-double"></i>
          </span>
          <input 
            [type]="hideConfirmPassword ? 'password' : 'text'"
            id="password_confirm"
            formControlName="password_confirm" 
            class="form-control"
            placeholder="Confirma tu nueva contraseña"
            [class.error]="passwordForm.get('password_confirm')?.hasError('passwordMismatch') && passwordForm.get('password_confirm')?.touched"
          >
          <button 
            type="button" 
            class="password-toggle"
            (click)="hideConfirmPassword = !hideConfirmPassword"
          >
            <i class="fas" [class.fa-eye]="!hideConfirmPassword" [class.fa-eye-slash]="hideConfirmPassword"></i>
          </button>
        </div>
        <div class="error-message" *ngIf="passwordForm.get('password_confirm')?.hasError('passwordMismatch') && passwordForm.get('password_confirm')?.touched">
          Las contraseñas no coinciden
        </div>
        <div class="error-message" *ngIf="passwordForm.get('password_confirm')?.hasError('required') && passwordForm.get('password_confirm')?.touched">
          Debes confirmar la nueva contraseña
        </div>
      </div>

      <!-- Mensajes de error y éxito -->
      <div class="alert alert-error" *ngIf="errorMessage">
        <i class="fas fa-exclamation-triangle"></i>
        {{ errorMessage }}
      </div>

      <div class="alert alert-success" *ngIf="successMessage">
        <i class="fas fa-check-circle"></i>
        {{ successMessage }}
      </div>

      <!-- Botones de acción -->
      <div class="form-actions">
        <button 
          type="submit" 
          class="btn btn-primary"
          [disabled]="!passwordForm.valid || !passwordStrength.isValid || submitting"
        >
          <i class="fas fa-spinner fa-spin" *ngIf="submitting"></i>
          <i class="fas fa-save" *ngIf="!submitting"></i>
          {{ submitting ? 'Actualizando...' : 'Actualizar Contraseña' }}
        </button>

        <button 
          type="button" 
          class="btn btn-secondary"
          (click)="skipForNow()"
          *ngIf="!mustChange"
        >
          <i class="fas fa-times"></i>
          Cancelar
        </button>

        <button 
          type="button" 
          class="btn btn-danger"
          (click)="logout()"
          *ngIf="mustChange"
        >
          <i class="fas fa-sign-out-alt"></i>
          Cerrar Sesión
        </button>
      </div>
    </form>

    <!-- Consejos de seguridad -->
    <div class="security-tips">
      <h4><i class="fas fa-shield-alt"></i> Consejos de Seguridad</h4>
      <ul>
        <li>No uses información personal en tu contraseña (nombre, fecha de nacimiento, etc.)</li>
        <li>No reutilices contraseñas de otros sitios o servicios</li>
        <li>Cambia tu contraseña regularmente (cada 3-6 meses)</li>
        <li>No compartas tu contraseña con nadie</li>
        <li>Usa un gestor de contraseñas si es posible</li>
      </ul>
    </div>

    <!-- Enlaces adicionales -->
    <div class="footer-links" *ngIf="!mustChange">
      <a routerLink="/dashboard" class="link">
        <i class="fas fa-arrow-left"></i>
        Volver al Dashboard
      </a>
      <span class="separator">|</span>
      <a routerLink="/usuarios" class="link">
        <i class="fas fa-users"></i>
        Gestión de Usuarios
      </a>
    </div>
  </div>
</div>
